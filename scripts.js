// Mapa centrado en Rincón de Romos
var map = L.map('map').setView([22.229454, -102.320402], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 18
}).addTo(map);

// Definir colonias en el mapa
var zonas = [
    {
        nombre: "Santa Cruz",
        coords: [
            [22.235941, -102.331601], [22.236359, -102.330914], [22.236299, -102.330421],
            [22.236001, -102.330442], [22.235842, -102.329863], [22.235584, -102.329885],
            [22.235663, -102.329713], [22.231453, -102.329691], [22.231254, -102.328790],
            [22.229943, -102.330099], [22.230122, -102.330421], [22.231254, -102.330442],
            [22.231552, -102.331322], [22.231433, -102.331515], [22.231592, -102.331880],
            [22.232803, -102.331451], [22.233022, -102.331987], [22.233220, -102.331923],
            [22.233439, -102.332524], [22.233637, -102.332524], [22.233796, -102.332953],
            [22.234452, -102.332803], [22.234929, -102.332395], [22.234869, -102.331987],
            [22.235564, -102.331730]
        ],
        color: "red"
    },
    {
        nombre: "Barrio de Chora",
        coords: [
            [22.235683, -102.329734], [22.235743, -102.325507], [22.233638, -102.325120],
            [22.231810, -102.324262], [22.229903, -102.324348], [22.229665, -102.323833],
            [22.228751, -102.323919], [22.228473, -102.327094], [22.227957, -102.327181],
            [22.227798, -102.329112], [22.227222, -102.329198], [22.227222, -102.330872],
            [22.227580, -102.330914], [22.227699, -102.331215], [22.228016, -102.331257],
            [22.228136, -102.331644], [22.228414, -102.331472], [22.228493, -102.329369],
            [22.230043, -102.330056], [22.231314, -102.328854], [22.231512, -102.329626],
            [22.235564, -102.329712]
        ],
        problema: "Drenaje colapsado",
        color: "orange"
    },
    {
        nombre: "Solidaridad",
        coords: [
            [22.225708, -102.330982], [22.224946, -102.331913], [22.224196, -102.331610],
            [22.223287, -102.331545], [22.223288, -102.330387], [22.220903, -102.330751],
            [22.220586, -102.329829], [22.220050, -102.329894], [22.219414, -102.328584],
            [22.219136, -102.328455], [22.219453, -102.328262], [22.219052, -102.326889],
            [22.219170, -102.326535], [22.219573, -102.326363], [22.219146, -102.324792],
            [22.222314, -102.324325], [22.222424, -102.324985], [22.225529, -102.324427],
            [22.225719, -102.330952]
        ],
        problema: "Alcantarillado en mal estado",
        color: "blue"
    },
    {
        nombre: "San Jose",
        coords: [
            [22.225512, -102.322993], [22.225472, -102.321212], [22.225492, -102.321121],
            [22.222562, -102.319130], [22.222413, -102.319994], [22.221186, -102.319184],
            [22.220978, -102.319286], [22.220913, -102.319415], [22.220804, -102.321469],
            [22.222701, -102.322547], [22.222646, -102.322961], [22.224732, -102.322961],
            [22.224810, -102.323017], [22.225496, -102.323006]
        ],
        problema: "Falta de alumbrado público",
        color: "green"
    },
    {
        nombre: "El Chaveño",
        coords: [
            [22.232966, -102.316758], [22.232966, -102.316382], [22.232012, -102.316425],
            [22.231983, -102.315009], [22.232251, -102.314988], [22.232261, -102.314183],
            [22.232196, -102.314188], [22.232176, -102.313625], [22.231541, -102.313636],
            [22.231397, -102.308261], [22.232747, -102.308100], [22.232539, -102.303701],
            [22.228169, -102.304312], [22.228626, -102.307118], [22.229110, -102.308422],
            [22.229182, -102.308465], [22.227648, -102.308625], [22.227860, -102.311692],
            [22.227432, -102.311719], [22.227462, -102.313511], [22.227204, -102.313532],
            [22.227428, -102.318253], [22.228304, -102.318186], [22.228339, -102.318146],
            [22.231633, -102.317912], [22.231609, -102.316797], [22.232959, -102.316721]
        ],
        problema: "Falta de recolección de basura",
        color: "purple"
    },
    {
        nombre: "El Potrero",
        coords: [
            [22.224719, -102.316285], [22.224630, -102.315534], [22.224511, -102.315008],
            [22.224451, -102.313828], [22.227450, -102.313527], [22.227430, -102.311725],
            [22.227848, -102.311682], [22.227649, -102.309043], [22.223895, -102.309021],
            [22.223537, -102.316274]
        ],
        problema: "Falta de alumbrado público",
        color: "green"
    },
    {
        nombre: "El Bajío",
        coords: [
            [22.247332, -102.311993], [22.247233, -102.304612], [22.250827, -102.299827],
            [22.250669, -102.299591], [22.247153, -102.304279], [22.247094, -102.304226],
            [22.246538, -102.304247], [22.246597, -102.304923], [22.244879, -102.306693],
            [22.244651, -102.305658], [22.243765, -102.305749], [22.243787, -102.306032],
            [22.242263, -102.306238], [22.242303, -102.307000], [22.242097, -102.307012],
            [22.242213, -102.310638], [22.242673, -102.310011], [22.243221, -102.310030],
            [22.243234, -102.309681], [22.243872, -102.309643], [22.244314, -102.309525],
            [22.244314, -102.309166], [22.246168, -102.308262], [22.246466, -102.312060],
            [22.246456, -102.312049], [22.247370, -102.312006], [22.247260, -102.304604]
        ],
        problema: "Falta de iluminación pública",
        color: "brown"
    },
    {
        nombre: "Escaleras",
        coords: [
            [22.256666, -102.333249], [22.256159, -102.331200], [22.256418, -102.331136],
            [22.256189, -102.329956], [22.256080, -102.329934], [22.256060, -102.329848],
            [22.256219, -102.329580], [22.255315, -102.329537], [22.255305, -102.329398],
            [22.254938, -102.329376], [22.254918, -102.329505], [22.252763, -102.329526],
            [22.252634, -102.328604], [22.252624, -102.328572], [22.250360, -102.329151],
            [22.250301, -102.328893], [22.248682, -102.328861], [22.248881, -102.329880],
            [22.247689, -102.330492], [22.247659, -102.331222], [22.247173, -102.331361],
            [22.245902, -102.330052], [22.245683, -102.330192], [22.245663, -102.331737],
            [22.245038, -102.331801], [22.243965, -102.331275], [22.243783, -102.331462],
            [22.244185, -102.331944], [22.244582, -102.334605], [22.243917, -102.334594],
            [22.243887, -102.335700], [22.245009, -102.335775], [22.246002, -102.336139],
            [22.246409, -102.336064], [22.246499, -102.335549], [22.246707, -102.335463],
            [22.247383, -102.336011], [22.249230, -102.335860], [22.249557, -102.336279],
            [22.250530, -102.336096], [22.250610, -102.336451], [22.251732, -102.336193],
            [22.253177, -102.336086], [22.253177, -102.336193], [22.254905, -102.335614],
            [22.254348, -102.334970], [22.255639, -102.334809], [22.255560, -102.333618],
            [22.256712, -102.333221]
        ],
        problema: "Escaleras en mal estado",
        color: "blue"
    },
    {
        nombre: "La Boquilla",
        coords: [
            [22.263593, -102.366974], [22.261905, -102.365815], [22.258052, -102.367553],
            [22.256642, -102.366094], [22.255073, -102.366223], [22.254656, -102.367081],
            [22.255212, -102.368648], [22.259959, -102.370815], [22.260475, -102.371888],
            [22.261666, -102.372467], [22.262441, -102.372532], [22.263553, -102.373562],
            [22.264923, -102.372939], [22.265449, -102.372178], [22.263285, -102.369613],
            [22.263752, -102.367929], [22.263632, -102.366878]
        ],
        problema: "Drenaje obstruido",
        color: "green"
    },
    {
        nombre: "Santa Anita",
        coords: [
            [22.227565693371638, -102.32141597658787],
            [22.22735216463307, -102.31697155636417],
            [22.22550736201857, -102.31695278100247],
            [22.225750688649583, -102.31837703390357],
            [22.224946219378484, -102.31844408912877],
            [22.22333726702074, -102.31841726703651],
            [22.22324539727139, -102.31853260201723],
            [22.223247880238375, -102.31862111490936],
            [22.223419204854512, -102.3186479369979],
            [22.224298171339715, -102.31924070518086],
            [22.224995878108498, -102.31920851867703],
            [22.225052985629425, -102.31993807955831],
            [22.22475875752252, -102.32059387962293],
            [22.225471359565418, -102.32110081713301],
            [22.22625844541136, -102.32145218649823],
            [22.226817099901414, -102.32149241964625],
            [22.227565693389067, -102.32141865890277]
        ],
        problema: "Problema sin especificar", // Agrega el problema que corresponda
        color: "skyblue" // Puedes cambiar el color según el caso
    },
    {
        nombre: "Santa Elena",
        coords: [
            [22.234561570235137, -102.32523370338224],
            [22.234477156146923, -102.32147861091984],
            [22.233921014988606, -102.31925237745723],
            [22.23418170643684, -102.31883797615514],
            [22.23418418921016, -102.31879237860463],
            [22.23405384355188, -102.31864351601328],
            [22.233018522280375, -102.3186998423731],
            [22.233004903739253, -102.32003986392792],
            [22.23323083783421, -102.32369303263343],
            [22.23328049362894, -102.32492148428823],
            [22.23379194729687, -102.32513203769564],
            [22.234564089831114, -102.32522859721759]
        ],
        problema: "Problema sin especificar", // Agrega el problema que corresponda
        color: "black" // Puedes cambiar el color según el caso
    },
    {
        nombre: "Centro de Rincón",
        coords: [
            [22.233244398424645, -102.3248712955941],
            [22.232976256856944, -102.31995748886305],
            [22.233006050389992, -102.3186700286135],
            [22.23167526636322, -102.3187236727841],
            [22.231605747449574, -102.31683539775142],
            [22.228219141439684, -102.31698560140256],
            [22.227345165328988, -102.31694805047863],
            [22.227538830952046, -102.32136833080166],
            [22.22651091029373, -102.32148634799609],
            [22.226252687500185, -102.32145416148983],
            [22.225895147462516, -102.32132005104715],
            [22.225507811392895, -102.32112156759204],
            [22.225463118697526, -102.32125567805896],
            [22.22551774309744, -102.32299911385883],
            [22.227747393633997, -102.32294546968565],
            [22.22777222251186, -102.3239217937829],
            [22.22979327786968, -102.3237823189109],
            [22.229803209273577, -102.32429730301072],
            [22.231670300730176, -102.32419001465337],
            [22.233269226285145, -102.32485520244896]
        ],
        problema: "Problema sin especificar", // Agrega el problema que corresponda
        color: "darkorange" // Puedes cambiar el color según el caso
    },
    {
        nombre: "Norte de Rincón",
        coords: [
            [22.235869168475066, -102.32542252074124],
            [22.235799651641493, -102.32132410561344],
            [22.235690410833353, -102.32131337677802],
            [22.235620893911115, -102.31904959250588],
            [22.235466963460585, -102.31833612495089],
            [22.235546411456156, -102.31825029426761],
            [22.235556342452437, -102.31819665009054],
            [22.234444066494884, -102.31860434583623],
            [22.234076616247776, -102.31864726117789],
            [22.234185858313747, -102.31880819370909],
            [22.233937580767922, -102.31917297411312],
            [22.23392764965694, -102.31926953363185],
            [22.234473859715948, -102.32147967372696],
            [22.234578135942332, -102.32522940174844],
            [22.235844341041012, -102.3254278852036]
        ],
        problema: "Problema sin especificar",
        color: "skyblue"
    },
    {
        nombre: "Fraccionamiento José Luis Macías, Valle del Real, Estancia de Chora, Emperadores",
        coords: [
            [22.23558005495917, -102.31815481618298],
            [22.235540330978893, -102.31746817057171],
            [22.23759603229398, -102.31498712738245],
            [22.23743217315023, -102.30770493034579],
            [22.2393388858748, -102.30731869227093],
            [22.238941656196673, -102.30311298878901],
            [22.236041845433228, -102.30315590413066],
            [22.232546103381342, -102.30388546493874],
            [22.232744727424983, -102.30817699910396],
            [22.231473528682184, -102.30834866047059],
            [22.231672154245658, -102.3137130781771],
            [22.232109129494603, -102.31367016283545],
            [22.232178648158627, -102.31419587577072],
            [22.232208441861225, -102.31421733344155],
            [22.232198510627732, -102.3149254365788],
            [22.23220844186121, -102.31493616541422],
            [22.231980023312836, -102.31495762308505],
            [22.231970092063158, -102.31503272493296],
            [22.231910504550306, -102.31504345376835],
            [22.231940298309897, -102.31634164285333],
            [22.231989954561815, -102.31633091401791],
            [22.231999885810083, -102.31650257538453],
            [22.232943351187192, -102.3164703888783],
            [22.232953282367916, -102.31676006743444],
            [22.231602635330457, -102.31683516928234],
            [22.231652291701973, -102.31875563082127],
            [22.23443302043211, -102.31860542712549],
            [22.235555227524387, -102.31818700253535],
            [22.23554529652802, -102.31741452638559],

        ],
        problema: "Problema sin especificar", // Agrega el problema que corresponda
        color: "Fuchsia" // Puedes cambiar el color según el caso
    },
];

// Función para obtener reportes de una colonia específica
function obtenerReportes(colonia, callback) {
    fetch('php/obtener_reportes.php')
        .then(response => response.json())
        .then(data => {
            // Filtrar reportes de la colonia seleccionada
            let reportesColonia = data.filter(reporte => reporte.colonia === colonia);
            callback(reportesColonia);
        })
        .catch(error => console.error('Error obteniendo reportes:', error));
}

// Dibujar las colonias en el mapa
zonas.forEach(zona => {
    let polygon = L.polygon(zona.coords, {
        color: "darkred",
        fillColor: zona.color,
        fillOpacity: 0.3,
        weight: 2,
        dashArray: "3, 3",
        zIndexOffset: 800
    }).addTo(map);

    // Evento de clic para mostrar reportes en el popup
    polygon.on('click', function () {
        obtenerReportes(zona.nombre, function (reportes) {
            let contenidoPopup = `<strong>${zona.nombre}</strong><br>`;
            if (reportes.length > 0) {
                reportes.forEach(rep => {
                    contenidoPopup += `<b>Problema:</b> ${rep.tipo_falla}<br>
                                       <b>Calle:</b> ${rep.calle} <br>
                                       <hr>`;
                });
            } else {
                contenidoPopup += "No hay reportes registrados.";
            }
            polygon.bindPopup(contenidoPopup).openPopup();
        });
    });
});
